<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard IoT AgrÃ­cola â€“ Arroz</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
    }

    header {
      background: #2e7d32;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      padding: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .card h3 {
      text-align: center;
      font-size: 14px;
      margin: 5px 0;
    }

    canvas {
      height: 140px !important;
    }

    .valor {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      margin-top: 6px;
      color: #2e7d32;
    }

    .ia {
      margin: 20px;
      padding: 15px;
      background: #e8f5e9;
      border-left: 5px solid #2e7d32;
      border-radius: 8px;
      font-weight: bold;
    }
  </style>
</head>

<body>

<header>
  ðŸŒ± Sistema IoT AgrÃ­cola â€“ Replante de Arroz
</header>

<!-- TARJETAS DE GRÃFICOS -->
<div class="charts">

  <div class="card">
    <h3>Humedad (%)</h3>
    <canvas id="gH"></canvas>
    <div class="valor" id="v-h">-- %</div>
  </div>

  <div class="card">
    <h3>Temp. Suelo (Â°C)</h3>
    <canvas id="gTS"></canvas>
    <div class="valor" id="v-ts">-- Â°C</div>
  </div>

  <div class="card">
    <h3>Temp. Ambiente (Â°C)</h3>
    <canvas id="gTA"></canvas>
    <div class="valor" id="v-ta">-- Â°C</div>
  </div>

  <div class="card">
    <h3>Luz</h3>
    <canvas id="gL"></canvas>
    <div class="valor" id="v-l">--</div>
  </div>

  <div class="card">
    <h3>pH</h3>
    <canvas id="gPH"></canvas>
    <div class="valor" id="v-ph">--</div>
  </div>

</div>

<!-- ASISTENCIA IA -->
<div class="ia" id="ia">
  ðŸ¤– Analizando condiciones del cultivo...
</div>

<script>
  function crearGrafico(id) {
    return new Chart(document.getElementById(id), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          data: [],
          borderColor: '#2e7d32',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { x: { display: false } }
      }
    });
  }

  const gH = crearGrafico("gH");
  const gTS = crearGrafico("gTS");
  const gTA = crearGrafico("gTA");
  const gL = crearGrafico("gL");
  const gPH = crearGrafico("gPH");

  function push(chart, value) {
    chart.data.labels.push('');
    chart.data.datasets[0].data.push(value);
    if (chart.data.labels.length > 12) {
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }

  function generarIA(d) {
    let m = "Condiciones adecuadas para el replante del arroz.";

    if (d.humedad < 60) m = "Humedad baja: se recomienda riego.";
    if (d.temp_suelo < 20) m = "Temperatura del suelo baja para arroz.";
    if (d.ph < 5.5 || d.ph > 7.5) m = "pH fuera del rango Ã³ptimo.";

    document.getElementById("ia").innerText = "ðŸ¤– " + m;
  }

  async function cargar() {
    const r = await fetch("/api/data");
    const d = await r.json();

    // Valores debajo de cada grÃ¡fico
    document.getElementById("v-h").innerText = d.humedad + " %";
    document.getElementById("v-ts").innerText = d.temp_suelo + " Â°C";
    document.getElementById("v-ta").innerText = d.temp_ambiente + " Â°C";
    document.getElementById("v-l").innerText = d.luz;
    document.getElementById("v-ph").innerText = d.ph;

    // GrÃ¡ficos
    push(gH, d.humedad);
    push(gTS, d.temp_suelo);
    push(gTA, d.temp_ambiente);
    push(gL, d.luz);
    push(gPH, d.ph);

    generarIA(d);
  }

  setInterval(cargar, 3000);
</script>

</body>
</html>
