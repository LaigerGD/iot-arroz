<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema IoT AgrÃ­cola â€“ Replante de Arroz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #e3f2fd;
        }
        .container {
            margin-top: 30px;
        }
        .card {
            margin-bottom: 20px;
        }
        .table-container {
            margin-top: 30px;
        }
        .chart-container {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center text-success">ðŸŒ¾ Sistema IoT AgrÃ­cola â€“ Replante de Arroz</h2>
        <div class="row">
            <div class="col-md-6 chart-container">
                <canvas id="humedadChart"></canvas>
                <p>Humedad (%)</p>
            </div>
            <div class="col-md-6 chart-container">
                <canvas id="tempSueloChart"></canvas>
                <p>Temperatura Suelo (Â°C)</p>
            </div>
            <div class="col-md-6 chart-container">
                <canvas id="tempAmbChart"></canvas>
                <p>Temperatura Ambiente (Â°C)</p>
            </div>
            <div class="col-md-6 chart-container">
                <canvas id="luzChart"></canvas>
                <p>Luz (lux)</p>
            </div>
            <div class="col-md-6 chart-container">
                <canvas id="phChart"></canvas>
                <p>pH</p>
            </div>
        </div>

        <div class="table-container">
            <h3 class="text-center text-success">ConexiÃ³n exitosa. Datos recibidos</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th scope="col">Humedad (%)</th>
                        <th scope="col">Temp. Suelo (Â°C)</th>
                        <th scope="col">Temp. Ambiente (Â°C)</th>
                        <th scope="col">Luz (lux)</th>
                        <th scope="col">pH</th>
                    </tr>
                </thead>
                <tbody id="dataTable">
                    <tr>
                        <td id="humedad">--</td>
                        <td id="temp_suelo">--</td>
                        <td id="temp_ambiente">--</td>
                        <td id="luz">--</td>
                        <td id="ph">--</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const ctxHumedad = document.getElementById('humedadChart').getContext('2d');
        const ctxTempSuelo = document.getElementById('tempSueloChart').getContext('2d');
        const ctxTempAmb = document.getElementById('tempAmbChart').getContext('2d');
        const ctxLuz = document.getElementById('luzChart').getContext('2d');
        const ctxPh = document.getElementById('phChart').getContext('2d');

        let humedadData = [];
        let tempSueloData = [];
        let tempAmbienteData = [];
        let luzData = [];
        let phData = [];

        let timeLabels = [];

        function updateCharts(data) {
            humedadData.push(data.humedad);
            tempSueloData.push(data.temp_suelo);
            tempAmbienteData.push(data.temp_ambiente);
            luzData.push(data.luz);
            phData.push(data.ph);

            timeLabels.push(new Date().toLocaleTimeString());

            if (humedadData.length > 10) {
                humedadData.shift();
                tempSueloData.shift();
                tempAmbienteData.shift();
                luzData.shift();
                phData.shift();
                timeLabels.shift();
            }

            updateChartData();
        }

        function updateChartData() {
            humedadChart.data.labels = timeLabels;
            humedadChart.data.datasets[0].data = humedadData;
            humedadChart.update();

            tempSueloChart.data.labels = timeLabels;
            tempSueloChart.data.datasets[0].data = tempSueloData;
            tempSueloChart.update();

            tempAmbChart.data.labels = timeLabels;
            tempAmbChart.data.datasets[0].data = tempAmbienteData;
            tempAmbChart.update();

            luzChart.data.labels = timeLabels;
            luzChart.data.datasets[0].data = luzData;
            luzChart.update();

            phChart.data.labels = timeLabels;
            phChart.data.datasets[0].data = phData;
            phChart.update();
        }

        const humedadChart = new Chart(ctxHumedad, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Humedad (%)',
                    data: humedadData,
                    borderColor: 'rgba(0, 255, 255, 1)',
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        });

        const tempSueloChart = new Chart(ctxTempSuelo, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Temp. Suelo (Â°C)',
                    data: tempSueloData,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        });

        const tempAmbChart = new Chart(ctxTempAmb, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Temp. Ambiente (Â°C)',
                    data: tempAmbienteData,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        });

        const luzChart = new Chart(ctxLuz, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Luz (lux)',
                    data: luzData,
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        });

        const phChart = new Chart(ctxPh, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'pH',
                    data: phData,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        });

        setInterval(() => {
            fetch('/api/data')  // Ajusta la URL a la que realmente estÃ¡s enviando datos
                .then(response => response.json())
                .then(data => {
                    updateCharts(data);
                    document.getElementById('humedad').textContent = data.humedad;
                    document.getElementById('temp_suelo').textContent = data.temp_suelo + " Â°C";
                    document.getElementById('temp_ambiente').textContent = data.temp_ambiente + " Â°C";
                    document.getElementById('luz').textContent = data.luz + " lux";
                    document.getElementById('ph').textContent = data.ph;
                })
                .catch(error => console.log('Error fetching data: ', error));
        }, 5000);
    </script>
</body>
</html>
